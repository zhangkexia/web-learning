Do._isay=function(){function e(t,i){if(!(this instanceof e))return new e(t,i);if(this.options=i,e.supportMultipleUpload&&!i._swf_only)this.uploader=new e.MultipleUpload(t,$.extend(!0,{},e._defaultOptions,i)),i.existFileNum&&this.uploader.setStat({total:this.options.existFileNum,current:this.options.existFileNum});else{var n=this;a.batch(SWFUPLOAD_FILES).done(function(){n.uploader=e.SWFUploadFactory(t,$.extend(!0,{},e._defaultOptions,i)),i.existFileNum&&n.uploader.setStat({total:i.existFileNum,current:i.existFileNum})})}}function t(){var e={done:[],fail:[]},t={done:function(i){return e.done.push(i),t},fail:function(i){return e.fail.push(i),t}};return{resolve:function(){for(var t,i=0;t=e.done[i++];)t.apply(this,arguments)},reject:function(){for(var t,i=0;t=e.fail[i++];)t.apply(this,arguments)},promise:t}}!function(e){e.fn.get_selection=function(){var e=this[0];if("selectionStart"in e){var t=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:t,text:e.value.substr(e.selectionStart,t)}}if(document.selection){e.focus();var i=e._saved_range||document.selection.createRange(),n=e.createTextRange(),a=n.duplicate();if(a.moveToBookmark(i.getBookmark()),n.setEndPoint("EndToStart",a),null==i||null==n)return{start:e.value.length,end:e.value.length,length:0,text:""};var o=i.text.replace(/[\r\n]/g,"."),r=e.value.replace(/[\r\n]/g,"."),s=r.indexOf(o,n.text.length);return{start:s,end:s+o.length,length:o.length,text:i.text}}return{start:e.value.length,end:e.value.length,length:0,text:""}},e.fn.set_selection=function(e,t){var n=this[0];if("selectionStart"in n)n.focus(),n.selectionStart=e,n.selectionEnd=t;else if(document.selection){n.focus();var a=n.createTextRange(),o=e;for(i=0;i<o;i++)n.value[i]&&n.value[i].search(/[\r\n]/)!=-1&&(e-=.5);for(o=t,i=0;i<o;i++)n.value[i]&&n.value[i].search(/[\r\n]/)!=-1&&(t-=.5);a.moveEnd("textedit",-1),a.moveStart("character",e),a.moveEnd("character",t-e),a.select()}return this.get_selection()},e.fn.replace_selection=function(e){var t=this[0];selection=this.get_selection();var i=selection.start,n=i+e.length;return t.value=t.value.substr(0,i)+e+t.value.substr(selection.end,t.value.length),this.set_selection(i,n),{start:i,end:n,length:e.length,text:e}},e.fn.wrap_selection=function(e,t,i,n){var a=this.get_selection().text,o=this.replace_selection(e+a+t);return void 0!==i&&void 0!==n?o=this.set_selection(o.start+i,o.start+i+n):""==a&&(o=this.set_selection(o.start+e.length,o.start+e.length)),o}}(jQuery),function(){function e(e,t){return F.replace("{bd}",e).replace("{hd}",t||"")}function t(e,t){return $.extend({},t,e)}function i(){U.acting&&!U._acted||(d.removeClass(b),p.removeAttr("disabled"))}function n(){d.addClass(b),p.attr("disabled",!0)}function a(e){"undefined"==typeof e&&(e=r());var t=e.replace(/((http|https)\:\/\/[\.\-\_\/a-zA-Z0-9\~\?\%\#\=\@\:\&\;\*\+]+\b[\?\#\/\*]*)/gi,function(e){return 0==e.indexOf("https://dou.bz")?"https://dou.bz/XXXXXX":"http://dou.bz/XXXXXX"}).length,a="_acting"in U,o=U._acted===!0,s=$(m);t>g||!a&&t<1||a&&!o?n():i();var l=g-t;if(l<0){s.html("<strong>"+l+"</strong>");var d=e.substring(g).replace(T,"&lt;").replace(I,"&gt;");R&&(d=d.replace(C,"&nbsp;")),d="<code>"+d+"</code>",h.html(e.substring(0,g)+d).css("marginTop",-c.scrollTop)}else h.html(""),l<11?s.html(l):s.html("")}function o(e){var t,i,n=c,o=r(e&&e.target),s=n.attr("data-minheight")||36;a(o),o||d.hasClass(x)?u.hide():u.show(),t=l.val(o).height(0).scrollTop(1e4).scrollTop(),n.css("height",Math.min(Math.max(t,s),650)),(i=n.scrollTop())>0?h.css("top",-i+"px"):h.css("top","")}function r(e){var t=e?e.value:c[0].value;return t?$.trim(t):""}function s(e){var t=e.getAttribute("data-action");t&&U.doAct(t,e)}var l,d,c,u,p,f,h,g=2e3,v="textarea",m="#isay-counter",_="#isay-act-field",b="isay-disable",y="active",x="focus",S="acting",w="field-up",F='<div class="field">{hd}<div class="bd">{bd}</div><a href="javascript:void(0);" class="bn-x isay-cancel">&times;</a></div>',E={fieldPos:"down",labelText:"分享生活点滴...",exclusive:!0,freshInput:!1,restartable:!1,buttonText:"发布"},U=Do.ISay={actions:{},initials:{},action_settings:{},setField:function(t,i){return d.addClass(S).find(_).html(e(t,i))},moveField:function(e){var t=d.find(_),i=t.siblings(".item");"up"===e?(t.insertBefore(i),d.addClass(w)):(t.insertAfter(i),d.removeClass(w))},hideField:function(){return d.removeClass(S)},fieldMsg:function(e,t){return this.setField('<div class="'+e+'">'+t+"</div>")},doAct:function(e,i){var n=this,a=n.actions;if(n._acting_elem=i,e&&e in a){var o=t(n.action_settings[e],E);n._upcoming_act=e,n._acting&&n._acting!=e&&o.exclusive&&n.cancel(!0),e=n._upcoming_act,o=t(n.action_settings[e],E),d.addClass(y),d.addClass("act-"+e),n.moveField(o.fieldPos),n.updateText(o),n._acted=!1,n._acting=e,a[e](i)}},updateText:function(e){u.text(e.labelText),p.val(e.buttonText)},done:function(e){this._acted=!0},cancel:function(e){var i=this,n=i._acting,o=t(i.action_settings[n],E);if(o.oncancel){var r=o.oncancel();if(r===!1)return}d.removeClass(S),d.removeClass("act-"+n),delete i._acting,o.freshInput?c.val("").blur():a(),!e&&o.restartable&&i.doAct(n)},close:function(){this.cancel(),c[0]._closed=!0,c.height("").val(""),u.show(),d.removeClass(y),$(m).html("")},check:o,validate:a,enable:i,disable:n,init:function(e,t){var i=this,r=$("#db-isay"),g=r[0];if(g&&!g._inited){g._inited=!0,i.root=d=r,i.node_label=u=r.find("label"),i.node_textarea=c=r.find(v),i.node_submit=p=r.find(":submit"),i.node_errorhighlight=h=r.find("p.error-highlighter"),i.node_field=f=r.find(_);for(var m in this.initials)this.initials[m](e,t);i.textarea_clone=l=c.clone().addClass("abs-out").attr("tabindex","-1"),c.removeAttr("name"),l.attr("id","isay-cont-clone").appendTo(c.parent()),o(),r.find("form").submit(function(e){return a(),r.hasClass(b)||U._acting&&!U._acted?void e.preventDefault():void n()}),c.bind("keyup input",o).focus(function(){u.hide(),c[0]._closed=!1,r.addClass(y).addClass(x)}).blur(function(e){r.removeClass(x),o(e)}).focus(),e&&s(e),r.delegate(".isay-close","click",function(e){return U.close(),!1}).delegate(".isay-cancel","click",function(e){U.cancel(),e.preventDefault()}).delegate("a","click",function(e){var t=e.currentTarget,i=t.getAttribute("href");"#"!==i&&"javascript:;"!==i&&i||e.preventDefault(),s(t)}).delegate("label","click",function(e){var t=$(e.currentTarget).attr("for"),i=t&&document.getElementById(t);i&&i.focus&&i.focus()})}}};U.actions.main=function(){U.cancel(),c.focus()};var C=/\s/g,T=/</g,I=/>/g,R=$.browser.msie&&$.browser.version<9}(),function(e){e.initials.mention=function(){Do.check_js(function(){return $.fn.tagsug&&window.Mustache},function(){var t=e.root.find("p.mention-highlighter");e.node_textarea.tagsug({url:"https://api.douban.com/shuo/in/complete?alt=xd&count={max}&callback=?&word=",highlight:!0,highlighter:t});e.node_textarea.parents("form").submit(function(i){var n=e.textarea_clone,a=n.val(),o=t.find("code");o.each(function(e,t){a=a.replace($(t).text(),"@"+t.getAttribute("data-id"))}),n.val(a)})})}}(Do.ISay);var n=function(){var e={},t=function(){};return t.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(e,t,i,n){if(n||(this.context=t,this.buffer=[]),!this.includes("",e))return n?e:void this.send(e);e=this.render_pragmas(e);var a=this.render_section(e,t,i);return a===!1&&(a=this.render_tags(e,t,i,n)),n?a:void this.sendLines(a)},send:function(e){""!==e&&this.buffer.push(e)},sendLines:function(e){if(e)for(var t=e.split("\n"),i=0;i<t.length;i++)this.send(t[i])},render_pragmas:function(e){if(!this.includes("%",e))return e;var t=this,i=this.getCachedRegex("render_pragmas",function(e,t){return new RegExp(e+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+t,"g")});return e.replace(i,function(e,i,n){if(!t.pragmas_implemented[i])throw{message:"This implementation of mustache doesn't understand the '"+i+"' pragma"};if(t.pragmas[i]={},n){var a=n.split("=");t.pragmas[i][a[0]]=a[1]}return""})},render_partial:function(e,t,i){if(e=this.trim(e),!i||void 0===i[e])throw{message:"unknown_partial '"+e+"'"};return"object"!=typeof t[e]?this.render(i[e],t,i,!0):this.render(i[e],t[e],i,!0)},render_section:function(e,t,i){if(!this.includes("#",e)&&!this.includes("^",e))return!1;var n=this,a=this.getCachedRegex("render_section",function(e,t){return new RegExp("^([\\s\\S]*?)"+e+"(\\^|\\#)\\s*(.+)\\s*"+t+"\n*([\\s\\S]*?)"+e+"\\/\\s*\\3\\s*"+t+"\\s*([\\s\\S]*)$","g")});return e.replace(a,function(e,a,o,r,s,l){var d,c=a?n.render_tags(a,t,i,!0):"",u=l?n.render(l,t,i,!0):"",p=n.find(r,t);return"^"===o?d=!p||n.is_array(p)&&0===p.length?n.render(s,t,i,!0):"":"#"===o&&(d=n.is_array(p)?n.map(p,function(e){return n.render(s,n.create_context(e),i,!0)}).join(""):n.is_object(p)?n.render(s,n.create_context(p),i,!0):"function"==typeof p?p.call(t,s,function(e){return n.render(e,t,i,!0)}):p?n.render(s,t,i,!0):""),c+d+u})},render_tags:function(e,t,i,n){for(var a=this,o=function(){return a.getCachedRegex("render_tags",function(e,t){return new RegExp(e+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+t+"+","g")})},r=o(),s=function(e,n,s){switch(n){case"!":return"";case"=":return a.set_delimiters(s),r=o(),"";case">":return a.render_partial(s,t,i);case"{":return a.find(s,t);default:return a.escape(a.find(s,t))}},l=e.split("\n"),d=0;d<l.length;d++)l[d]=l[d].replace(r,s,this),n||this.send(l[d]);if(n)return l.join("\n")},set_delimiters:function(e){var t=e.split(" ");this.otag=this.escape_regex(t[0]),this.ctag=this.escape_regex(t[1])},escape_regex:function(e){if(!arguments.callee.sRE){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(arguments.callee.sRE,"\\$1")},find:function(e,t){function i(e){return e===!1||0===e||e}e=this.trim(e);var n;if(e.match(/([a-z_]+)\./gi)){var a=this.walk_context(e,t);i(a)&&(n=a)}else i(t[e])?n=t[e]:i(this.context[e])&&(n=this.context[e]);return"function"==typeof n?n.apply(t):void 0!==n?n:""},walk_context:function(e,t){for(var i=e.split("."),n=void 0!=t[i[0]]?t:this.context,a=n[i.shift()];void 0!=a&&i.length>0;)n=a,a=a[i.shift()];return"function"==typeof a?a.apply(n):a},includes:function(e,t){return t.indexOf(this.otag+e)!=-1},escape:function(e){return e=String(null===e?"":e),e.replace(/&(?!\w+;)|["'<>\\]/g,function(e){switch(e){case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return e}})},create_context:function(e){if(this.is_object(e))return e;var t=".";this.pragmas["IMPLICIT-ITERATOR"]&&(t=this.pragmas["IMPLICIT-ITERATOR"].iterator);var i={};return i[t]=e,i},is_object:function(e){return e&&"object"==typeof e},is_array:function(e){return"[object Array]"===Object.prototype.toString.call(e)},trim:function(e){return e.replace(/^\s*|\s*$/g,"")},map:function(e,t){if("function"==typeof e.map)return e.map(t);for(var i=[],n=e.length,a=0;a<n;a++)i.push(t(e[a]));return i},getCachedRegex:function(t,i){var n=e[this.otag];n||(n=e[this.otag]={});var a=n[this.ctag];a||(a=n[this.ctag]={});var o=a[t];return o||(o=a[t]=i(this.otag,this.ctag)),o}},{name:"mustache.js",version:"0.4.0-dev",to_html:function(e,i,n,a){var o=new t;if(a&&(o.send=a),o.render(e,i||{},n),!a)return o.buffer.join("\n")}}}();!function(e){function t(t){var i=t[0];if(i){var n=document.createElement("span");n.className=t[0].className,n.innerHTML=t.val().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n=$(n).css({position:"absolute",visibility:"hidden"}),t.after(n);var a=n.width()+10,o=Math.max(Math.min(a+4,500),200);n.remove(),t.width(a).mouseenter(function(e){t.hasClass("field-title")&&t.addClass("editable-over")}).mouseleave(function(e){$(this).removeClass("editable-over")}).click(function(e){t.hasClass("field-title")&&(t.width(o),t.removeClass("field-title").removeClass("editable-over").focus().select())}).blur(function(i){var n=$.trim(this.value);n?n===r?(this.value="网址",e._acted=!0,t.addClass("field-title")):(e._acted=!0,t.addClass("field-title")):e._acted=!1,e.validate()}).keyup(function(t){var i=$.trim(this.value);i?e.enable():e.disable(),13===t.keyCode&&(t.preventDefault(),t.stopPropagation(),i&&(this.blur(),e.node_submit.focus()))}).keypress(function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation())})}}function i(i,a){i&&(e.fieldMsg("waiting","正在获取网址信息..."),e.node_textarea.focus(),$.post("/j/misc/get_url_info",{url:i,ck:get_cookie("ck"),need_images:d},function(a){var s,d;if(a.r)e.fieldMsg("error",(a.error||"获取网址信息失败")+'。 <a href="javascript:void(0);" data-action="share">重新输入</a>');else{s=a.title,s.length>40?s=s.substring(0,40)+"...":"网址"===s&&(s=r),d=["<div>",a.abstract||i,"</div>",a.images&&a.images.length?n.to_html(l,a):""].join("");var c=e.setField(d,'<div class="hd"><input class="field-title" name="title" maxlength="200"></div><input type="hidden" name="url"><input type="hidden" name="abstract"><input type="hidden" name="image"><input type="hidden" name="image_num"><input type="hidden" name="t" value="I">');c.find("input[name=abstract]").val(a.abstract),c.find("input[name=image]").val(a.images[0]||""),c.find("input[name=image_num]").val(a.images.length||0),c.find("input[name=url]").val(a.url),t(c.find("input.field-title").val(s)),s===r&&c.find("input.field-title").click(),e._acted=!0,o(),e.root.find(".isay-cancel").show(),e.root.find(".highlighter").css("top",$("#isay-act-field").height()+30+1+"px")}},"json"))}var a="active",o=e.validate,r="抱歉，获取网页标题失败，请您手动输入",s='<input type="text" id="isay-inp-url" value="http://" class="inp-text url" name="url"><span class="bn-flat"><input type="button" value="输入网址" class="bn-preview"></span>',l=['<div class="share-pic">','<div class="pic" tabindex="0">','<div class="pic-wrap">','<img class="selected-pic" src="{{images.0}}" />',"</div>",'<a class="bn-x remove-pic" href="javascript: void 0;">×</a>','{{#images.1}}<a class="btn-change" href="javascript: void 0;">更换</a>',"</div>",'<div class="share-pic-choose">',"<h5>选择发布时的配图",'<a href="javascript:void(0);" class="bn-x choose-cancel" style="display: inline;">×</a>',"</h5>",'<ul>{{#images}}<li><a href="javascript: void 0;"><img src="{{.}}"></a></li>{{/images}}</ul>{{/images.1}}',"</div>","</div>"].join(""),d=$("#db-isay").hasClass("isay-new")?0:1;e.initials.share=function(){function t(t){var i,n=$(".share-pic-choose"),a=e.node_field,o=t&&t.length?t:$();n.hide().siblings().show().parent().prev().show(),a.find(".hd").show(),e.root.find(".isay-links .active").removeClass("test"),i=o.find("img").attr("src"),a.find(".selected-pic").attr("src",i),a.find('input[name="image"]').val(i),o.length||a.find(".pic").remove()}e.root.delegate(".bn-preview","click",function(e){var t=$("#isay-inp-url");t.length&&i($.trim(t.val())),e.preventDefault()}).delegate(".share-pic .pic","click",function(){var t=$(".share-pic-choose");t.length&&(t.show().siblings().hide().parent().prev().hide(),e.node_field.find(".hd").hide(),e.root.find(".isay-links .active").addClass("test"),t.find(".active").length||t.find("li").eq(0).addClass("active"))}).delegate(".remove-pic","click",function(){return t(),!1}).delegate(".choose-cancel","click",function(){var i=e.node_field.find("li.active");t(i)}).delegate(".share-pic-choose li","click",function(){var t=$(this),i="active";t.addClass(i).siblings().removeClass(i),e.node_field.find(".choose-cancel").trigger("click")})},e.actions.share=function(){function t(){return $.trim(n.val())?(n.prev().hide(),n.next().find("input").removeAttr("disabled"),!0):(n.prev().show(),void n.next().find("input").attr("disabled","disabled"))}e.setField(s);var n=$("#isay-inp-url");n.focus(function(e){n.closest("div").addClass(a)}).blur(function(e){n.closest("div").removeClass(a)}).keypress(function(e){13==e.keyCode?(e.preventDefault(),e.stopPropagation(),i($.trim(this.value))):t()}).bind("input",t)[0].focus(),n[0].select(),o()},e.action_settings.share={fieldPos:"up",labelText:"我的推荐理由...",restartable:!0,oncancel:function(){"share"===self._upcoming_act&&e.doAct(act,e._acting_elem)}}}(Do.ISay),function(){!function(e){var t=function(){return"multiple"in document.createElement("input")}()&&window.FormData&&window.XMLHttpRequest,i=function(e,t){return function(){e.apply(t,arguments)}},n=function(){var e=[];return function(){return e.push(0),e.length}}(),a=function(e,t){this.fileNode=e,this.options=t||{},this.fileList=[],this.recycleList=[],this.current=0,this._state=!0,this.total=0,this.init()};a.prototype={init:function(){$.browser.mozilla?this.fileNode.attr("accept","image/*"):this.fileNode.attr("accept",this.options.fileTypes.replace(/\*\./g,"image/").replace(/\;/g,",")),this.fileNode.bind("change",i(this.handleChange,this))},handleChange:function(e){var t,i,a,o,r=this.options,s=e.target.files;if(r.fileUploadLimit-this.total===0)return this.enable(!0),void r.onFileQueueFull();if(s.length){for(var l=0;a=s[l];l++)t="file-"+n(),i={id:"file-"+n(),file:a},o=this.validate(a),this.total>=r.fileUploadLimit?"pass"===o&&(this.recycleList.push(i),r.onFileSelected({id:i.id,name:a.name}),r.onFileQueueError(i.id,r.errorMessage.overnum)):(r.onFileSelected({id:i.id,name:a.name}),"pass"===o?(this.fileList.push(i),r.onFileQueued({id:i.id,name:a.name}),this.total++):r.onFileQueueError(i.id,r.errorMessage[o]));r.onFilesQueueComplete(this.fileList),this._state===!0&&this.upload(),this.enable(!1)}},enable:function(e){return"undefined"==typeof e?this._state:(this._state=e,void this.options.onStateChange(e))},validate:function(e){var t="pass";return this.options.fileTypes.indexOf("."+e.type.split("/")[1]+";")<0?t="invalidType":e.size<100?t="invalidSmall":e.size/1048576>parseFloat(this.options.sizeLimit)&&(t="invalidLarge"),t},removeFromRecycleList:function(e){e&&(this.recycleList=this.recycleList.filter(function(t){return t.id!=e}))},remove:function(e){if(e&&(this.current--,this.total--,0===this.total&&this.options.onStateChange(!1),this.options.onFileDeleted(e),!(this.total>=this.options.fileUploadLimit)&&this.recycleList.length)){var t=this.recycleList.shift();this.fileList.push(t),this.total++,this.options.onFileQueued({id:t.id,name:t.file.name}),this.enable(!1),this.upload()}},stat:function(){return{current:this.current,total:this.total}},setStat:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},upload:function(){var e=this.options;if(0===this.fileList.length)return this.enable(!0),void e.onUploadComplete(this.total);var t=new FormData,n=this.fileList.shift();t.append(e.fileName,n.file);for(var a in e.params)e.params.hasOwnProperty(a)&&t.append(a,e.params[a]);var o=new XMLHttpRequest;o.onreadystatechange=i(function(t){if(4===o.readyState)if(200===o.status){e.onUploadProgress(n.id,100);var i=$.parseJSON(t.target.responseText);i.r?(this.total--,e.onUploadError($.extend(i,{file_id:n.id}))):(this.current++,e.onUploadSuccess($.extend(i,{file_id:n.id}))),this.upload()}else this.total--,e.onUploadError({file_id:n.id,msg:"上传失败"}),this.upload()},this),o.upload.onprogress=function(t){var i=0;t.lengthComputable&&(i=t.loaded/t.total*100|0),i>95&&(i=95),e.onUploadProgress(n.id,i)},e.onUploadStart(n.id),o.open("POST",e.uploadUrl,!0),o.send(t)}},e.MultipleUpload=a,e.supportMultipleUpload=t}(this),function(e){function t(e){this.customSettings.uploadRecorder.total>=this.customSettings.fileUploadLimit||(this.customSettings.onFileSelected({id:e.id,name:e.name}),this.recordUpload(e))}function i(e,t,i){var n=this.customSettings;switch(t){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:n.onFileQueueError(e.id,n.errorMessage.invalidLarge);break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:n.onFileQueueError(e.id,n.errorMessage.invalidSmall);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:n.onFileQueueError(e.id,n.errorMessage.invalidType);break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:n.onFileQueueError(e&&e.id,n.errorMessage.overnum);break;default:n.onFileQueueError(e.id,n.errorMessage.unknown)}}function n(e,t){this.startUpload()}function a(e){var t=this.customSettings;return t.uploadRecorder.files[e.id]?(this.enable(!1),void t.onUploadStart(e.id)):(t.onFileQueueError(null,e.name+"超出上传数量限制"),this.cancelUpload(e.id),void this.stopUpload())}function o(e,t,i){var n=t/i*100|0;n>95&&(n=95),this.customSettings.onUploadProgress(e.id,n)}function r(e,t){var i=$.parseJSON(t);this.customSettings.uploadRecorder.current++,this.customSettings.onUploadSuccess($.extend(i,{file_id:e.id}))}function s(e,t,i){this.customSettings.onUploadError($.extend({errorMessage:i,errorCode:t},{file_id:e.id}))}function l(e){var t=this.customSettings;t.onUploadProgress(e.id,100),this.startUpload(),t.uploadRecorder.current===t.uploadRecorder.total&&(t.onUploadComplete(t.uploadRecorder.total),this.enable(!0))}function d(e){var t=this.customSettings;t.onFilesQueueComplete(t.uploadRecorder.files)}var c={debug:!1,flash_url:"/swf/swfupload.new.swf",upload_url:"",post_params:{},file_types:"*.jpg;*.jpeg;*.bmp;*.gif;*.png;",file_post_name:"file",file_types_description:"图片文件",file_queue_limit:0,file_size_limit:"10 MB",button_placeholder_id:"file_upload",button_width:160,button_height:40,button_image_url:"/pics/bn_swf_upload1.png",file_queued_handler:t,file_queue_error_handler:i,file_dialog_complete_handler:n,upload_start_handler:a,upload_progress_handler:o,upload_error_handler:s,upload_success_handler:r,upload_complete_handler:l,queue_complete_handler:d},u=function(e,t){return e.attr("id")||e.attr("id","swfupload-file-"+1e3*Math.random()|0),SWFUpload.prototype.remove=function(e){this.customSettings.uploadRecorder.total--,this.customSettings.uploadRecorder.current--,delete this.customSettings.uploadRecorder.files[e],this.customSettings.onFileDeleted(e),this.enable(this.customSettings.uploadRecorder.total)},SWFUpload.prototype.recordUpload=function(e){this.customSettings.uploadRecorder.total++,this.customSettings.uploadRecorder.files[e.id]=e},SWFUpload.prototype.enable=function(e){return"undefined"==typeof e?this.customSettings._state:(this.customSettings._state=e,void this.customSettings.onStateChange(e))},SWFUpload.prototype.stat=function(){return{current:this.customSettings.uploadRecorder.current,total:this.customSettings.uploadRecorder.total}},SWFUpload.prototype.setStat=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.customSettings.uploadRecorder[t]=e[t])},new SWFUpload($.extend(!0,{},c,{upload_url:t.uploadUrl,post_params:t.params,file_types:t.fileTypes+t.fileTypes.toUpperCase(),file_post_name:t.fileName,file_queue_limit:t.fileUploadLimit,file_size_limit:1048576*parseFloat(t.sizeLimit),button_placeholder_id:e.attr("id"),button_width:t.buttonWidth,button_height:t.buttonHeight,button_image_url:t.buttonImageUrl,custom_settings:$.extend(!0,t,{_state:!0,uploadRecorder:{total:0,current:0,files:{}}})}))};e.SWFUploadFactory=u}(this),this._defaultOptions={fileName:"file",uploadUrl:"",sizeLimit:"10 M",fileTypes:"*.jpg;*.jpeg;*.bmp;*.gif;*.png;",fileUploadLimit:20,buttonWidth:98,buttonHeight:29,buttonImageUrl:"/pics/upload-btns1.png",params:{},errorMessage:{unknown:"未知错误",overnum:"超出上传数量限制",invalidLarge:"图片太大了",invalidSmall:"图片太小了",invalidType:"不支持的图片类型"},onFileSelected:function(e){},onFileQueued:function(e){},onFileQueueError:function(e,t){},onFilesQueueComplete:function(e){},onFileQueueFull:function(){},onUploadStart:function(e){},onUploadProgress:function(e,t){},onUploadSuccess:function(e){},onUploadError:function(e){},onUploadComplete:function(){},onFileDeleted:function(e){},onStateChange:function(e){}}}.call(e),e.prototype={stat:function(){return this.uploader.stat()},setStat:function(e){return this.uploader.setStat(e)},removeFromRecycleList:function(e){this.uploader.removeFromRecycleList&&this.uploader.removeFromRecycleList(e)},remove:function(e){this.uploader.remove(e)}};var a=function(e,t,i,n,o,r){if(e){"function"==typeof t&&(n=t,t=""),"function"==typeof i&&(n=i,i="");var s=function(){a.loaded[e]=1,n&&n(e),n=null,clearTimeout(d)};if(a.loaded[e])return a.loading[e]&&(a.loading[e]=0),void setTimeout(function(){s()},0);if(a.loading[e])return void setTimeout(function(){a(e,t,i,n,o,r)},10);a.loading[e]=1;var l,d=setTimeout(function(){try{r(e)}catch(e){}},o||6e3),c=t||e.toLowerCase().split(/\./).pop().replace(/[\?#].*/,"");"js"===c?(l=document.createElement("script"),l.setAttribute("type","text/javascript"),l.setAttribute("src",e),l.setAttribute("async",!0)):"css"===c&&(l=document.createElement("link"),l.setAttribute("type","text/css"),l.setAttribute("rel","stylesheet"),l.setAttribute("href",e)),i&&(l.charset=i),"css"===c?setTimeout(function(){s()},0):(l.onerror=function(){s(),l.onerror=null},l.onload=l.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(setTimeout(function(){s()},0),l.onload=l.onreadystatechange=null)});var u=function(){var e=document.getElementsByTagName("script");return e[e.length-1]}();u.parentNode.insertBefore(l,u)}};a.loaded=window.__external_files_loaded=window.__external_files_loaded||{},a.loading=window.__external_files_loading=window.__external_files_loading||{},a.batch=function(){if(0!=arguments.length){var e=Array.prototype.slice.call(arguments);"[object Array]"==Object.prototype.toString.call(e[0])&&(e=e[0]);for(var i,n=t(),o=[],r=function(){o.pop(),0===o.length&&n.resolve()},s=0;i=e[s++];)o.push(i),a(i,r);return n.promise}},function(e){"use strict";function t(e){return this instanceof t?void(this.imageFile=e):new t(e)}var i="undefined"!=typeof FileReader,n=function(e){return"[object Function]"===Object.prototype.toString.call(e)};t.isSupported=i;var a={},o=function(e,t,i){if(a[e]=t,a.dataURI){var n=new Image;n.onload=function(){a.width=n.width,a.height=n.height,i(a)},n.src=a.dataURI}};t.prototype.getInfo=function(e){var t,i=this,a=i.imageFile;e=n(e)?e:function(){},t=new FileReader,t.onload=function(t){o("dataURI",t.target.result,e)},t.readAsDataURL(a)},e.ImageFileInspector=t}($),function(e){function t(e){return"[object Function]"===Object.prototype.toString.call(e)}function i(e,t){if(!(this instanceof i))return new i(e,t);if("string"==typeof e)return new i(document.getElementById(e),t);if(!e||1!==e.nodeType)throw Error("need a dom node");this.node=e,this.options=t||{},this._logMessage="",this._init()}var n="addEventListener"in document&&"onpaste"in document;i.isSupported=n,i.prototype={constructor:i,_init:function(){var e=this;e.node.addEventListener("paste",function(t){return e._pasteHandler(t)},!1)},_log:function(e){this._logMessage+=e+"\n"},print:function(){"undefined"!=typeof console&&console.log&&console.log(this._logMessage)},_pasteHandler:function(e){var i,n,a,o,r,s,l,d=this,c=e.clipboardData,u=0;if(!c||!(i=c.items)||(r=c.getData("Text")))return void d._log("sorry, browser not support");if((s=i.length)>0){for(;u<s;u++)if(i[u].type.indexOf("image")>=0){n=i[u];break}n?(a=n.getAsFile(),o=new $.ImageFileInspector(a),o.getInfo(function(e){(l=d.options.complete)&&t(l)&&(e.blob=a,l(e))})):d._log("image is not found in clipboard")}}},e.PasteToImage=i}($),function(e){e.initials.paste_image=function(){$.PasteToImage.isSupported&&$.PasteToImage(e.node_textarea.get(0),{complete:e._upload_datauri})}}(Do.ISay),function(e){function t(t,i){function n(t){var i;if(l=!1,!(t.dataTransfer&&(i=t.dataTransfer.types)&&(i=s.call(i))&&i.indexOf("Files")<0||(l=!0,(r=r.add($(t.target))).length>1))){var n;"pic"!==e._acting&&o.find('.isay-links [data-action="pic"]').click(),n=o.find(".field"),0===n.find(".drag-tips").length&&($('<div class="drag-tips">拖拽图片到这里，直接上传</div>').bind("dragenter dragover",function(e){e=e.originalEvent,$(this).addClass("over"),e.stopImmediatePropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}).bind("dragleave",function(e){e=e.originalEvent,$(this).removeClass("over"),e.stopImmediatePropagation()}).bind("drop",function(t){t=t.originalEvent,t.preventDefault();for(var i,n,a=0;(i=t.dataTransfer.files[a])&&(function(t){n=new $.ImageFileInspector(t),n.getInfo(function(i){i.blob=null,i.file=t,e._upload_datauri(i)})}(i),e._support_multiple_pics);a++);o.removeClass("drag"),r=$()}).appendTo(n),o.addClass("acting")),o.addClass("drag"),t.dataTransfer.dropEffect="none",t.preventDefault()}}function a(e){n(e),document.removeEventListener(e,a)}if(e.initials.dragdrop=$.noop,"addEventListener"in document&&"ondrag"in document){$textarea=e.node_textarea;var o=e.root,r=$(),s=Array.prototype.slice,l=!1;$textarea.unbind("dragenter");var d=function(e,t){document.addEventListener(e,t,!0)};d("dragenter",n),d("dragover",function(e){l===!0&&(e.dataTransfer.dropEffect="none",e.preventDefault())}),d("dragover",a),d("dragleave",function(e){0===(r=r.not($(e.target))).length&&o.removeClass("drag")})}}e.initials.dragdrop=t}(Do.ISay),function(t){function i(){h.total=0,h.current=0,h.updateTotal(),h.updateCurrent(),s.find(".field").remove()}function n(t,i){var n=e(t,i);h.add(n)}function a(){t.setField(p,f),l=s.find(".add-photo"),s.find(".bd").addClass("group-pics"),s.find(".isay-cancel").hide(),n(l.find("input[type=file]"),$.extend(g,{buttonWidth:52,buttonHeight:52})),t.root.find(".btn-group").css("overflow","hidden")}function o(e,t){var i=e.find(".field-error");0===i.length&&(i=$('<div class="field-error"></div>'),i.appendTo(e)),i.show().html(t),setTimeout(function(){i.fadeOut()},3e3)}function r(e,t){for(var i in t)t.hasOwnProperty(i)&&(e=e.replace(new RegExp("{{"+i+"}}","ig"),t[i]));return e}t._support_multiple_pics=!0;var s,l,d="3 M",c='<div class="item-photo item-photo{{slot_id}}"><img src="{{url}}" class="thumb"><a href="#" class="lnk-remove-photo" data-pid="{{id}}">&times;</a></div>',u='<div class="item-photo item-photo{{id}} circle-progress"><i></i><i></i><i></i><span class="progress">0%</span></div>',p='<div class="add-photo"><i>+</i><span class="uploader-input"><input tabindex="2" title="上传图片" type="file" multiple></span><input type="hidden" name="uploaded" value=""></div><div class="say-pics-tip">还可以上传<i>0</i>张（按住'+(navigator.userAgent.search("Mac")!==-1?"&#8984;":"ctrl")+"可选中多张）</div>",f='<a href="javascript:void(0);" tabindex="2" data-action="topic" class="topic-btn" title="添加话题">#&nbsp;话题</a>',h={uploaders:[],add:function(e){this.uploaders.push(e)},current:0,total:0,reset:function(){for(var e,t=0;e=this.uploaders[t++];)e.setStat({total:0,current:0})},updateCurrent:function(){for(var e,t=0;e=this.uploaders[t++];)e.setStat({current:this.current})},updateTotal:function(){for(var e,t=0;e=this.uploaders[t++];)e.setStat({total:this.total});s.find(".say-pics-tip i").text(UPLOAD_LIMIT-this.total)},syncData:function(){var e=[];$.each(s.find(".thumb"),function(){e.push(this.getAttribute("src",2))}),s.find("input[name=uploaded]").val(e.join("|")),e.length==UPLOAD_LIMIT?s.find(".add-photo").hide():s.find(".add-photo").show()}},g={fileName:"image",uploadUrl:UPLOAD_URL,params:{ck:get_cookie("ck"),upload_auth_token:UPLOAD_AUTH_TOKEN},fileTypes:"*.jpg;*.jpeg;*.bmp;*.gif;*.png;",fileUploadLimit:UPLOAD_LIMIT,buttonWidth:60,buttonHeight:22,buttonImageUrl:"",_swf_only:!1,onFileSelected:function(e){s||$("#db-isay").find(".ico-pic").click(),"pic"!==t._acting&&t.doAct("pic"),0===s.find(".add-photo").length&&(i(),a()),s.find(".field").show(),$(r(u,e)).insertBefore(l)},onFileQueued:function(e){h.total++},onFileQueueError:function(e,t){o(s.find(".field"),t),s.find(".item-photo"+e).remove()},onFileQueueFull:function(){o(s.find(".field"),"一次最多传9张")},onFilesQueueComplete:function(){h.updateTotal()},onUploadError:function(e){if(e.file_id){var t=s.find(".item-photo"+e.file_id);t.removeClass("circle-progress").addClass("item-error").find(".progress").removeClass("progress").addClass("error-msg").text(e.msg),h.total--,h.current--,h.updateTotal(),h.updateCurrent(),setTimeout(function(){t.fadeOut(function(){t.remove()})},3e3)}},onUploadProgress:function(e,t){var i=s.find(".item-photo"+e);i.find(".progress").text(t+"%");var n=i.find("i:nth-child(2)"),a=i.find("i:nth-child(1)");if(0!==a.length){var o=3.6*t+45;t>=50&&!a[0].className?a[0].className="circle-right":this.value<50&&a[0].className&&(a[0].className=""),n.css({"-webkit-transform":"rotate("+o+"deg)","-moz-transform":"rotate("+o+"deg)",transform:"rotate("+o+"deg)"
})}},onUploadSuccess:function(e){return e.r?void this.onUploadError(e):(s.find(".item-photo"+e.file_id).replaceWith(r(c,{id:e.id,slot_id:e.file_id,url:e.url})),h.syncData(),h.current++,h.updateCurrent(),t._acted=!0,void t.validate())},onStateChange:function(e){}};n($("#isay-upload-inp"),g),t._upload_datauri=function(e){if(!t._acting||"pic"===t._acting){t.root.find('.isay-links [data-action="pic"]').click(),t._upload_datauri._id++;var i=g,n={id:t._upload_datauri._id},a=function(e,t){i.onUploadError({file_id:e,msg:t})},r=function(e){var t=new FormData;t.append(i.fileName,e.data.blob||e.data.file),t.append("ck",get_cookie("ck"));var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===this.DONE)if(200===n.status){var t=JSON.parse(n.responseText);if(t.r)return void a(e.id,t.msg);i.onUploadSuccess($.extend(t,{file_id:e.id}))}else a(e.id,"上传失败")},n.upload.onprogress=function(t){var n=0;t.lengthComputable&&(n=t.loaded/t.total*100|0),n>95&&(n=95),i.onUploadProgress(e.id,n)},n.open("POST",i.uploadUrl,!0),n.send(t)};if(h.total>=UPLOAD_LIMIT)return void o(s.find(".field"),"一次最多传9张");if(i.onFileSelected(n),i.onFileQueued(),(e.blob||e.file).size>1e6*parseInt(d,10))return void a(n.id,"图片超过"+d);i.onFilesQueueComplete(),n.data=e,r(n)}},t._upload_datauri._id=0,t.initials.pic=function(){s=t.node_field,s.delegate(".isay-cancel","click",function(e){i()}),s.delegate(".lnk-remove-photo","click",function(e){e.preventDefault();var i=$(this).parent();i.fadeOut(function(){i.remove(),h.syncData(),t.doAct("pic")}),h.total--,h.current--,h.updateTotal(),h.updateCurrent(),h.total||(t._acted=!1,t.validate())})},t._initial_upload_area=function(e,t,i){n(e,$.extend(g,{buttonWidth:t,buttonHeight:i}))}}(Do.ISay),function(e){var t="addEventListener"in document&&"ondrag"in document,i="upload-section",n='<div class="'+i+'">'+(t?'<p class="drag-tip">拖图到框里上传</p>':"")+'<a href="javascript: void 0;" class="upload-btn">上传照片</a><p>按住'+(navigator.userAgent.search("Mac")!==-1?"command":"ctrl")+"键可最多选中9张</p></div>",a='<a href="javascript:void(0);" tabindex="2" data-action="topic" class="topic-btn" title="添加话题">#&nbsp;话题</a>',o='<div class="pic-upload"><input tabindex="2" title="上传图片" type="file" multiple></div>',r=$("#isay-upload-inp"),s=".item-photo",l=".upload-btn";e.actions.pic=function(){var t,i,d,c=e.node_field,u=e.root.find(".isay-links"),p=e.root.find(".btn-group");u.find('[data-action="pic"]').click(),c.find(s).length?(e.root.addClass("acting"),e.node_field.find("input").removeAttr("disabled"),e._acted=!0):(e.setField(n,a),e.root.find(".isay-cancel").hide(),c.undelegate(l,"click").delegate(l,"click",function(){return r.click(),!1}),p.find(".pic-upload").length?(p.find(".pic-upload").css("visibility","visible"),p.css("overflow","visible")):($(o).appendTo(p).css("visibility","visible"),t=c.find(l),i=t.width(),d=t.height(),p.css("overflow","visible"),e._initial_upload_area(p.find(".pic-upload input:last"),i,d))),e.validate(),e.node_textarea.focus()},"pic"===e._acting&&e.doAct("pic")}(Do.ISay),function(e){e.action_settings.pic={fieldPos:"down",restartable:!0,freshInput:!1,labelText:"分享我的照片",oncancel:function(){if(e.root.find(".pic-upload").css("visibility","hidden"),"main"===e._upcoming_act)e.hideField(),e.node_field.find("input").attr("disabled","disabled");else if("pic"!==e._upcoming_act&&e.node_field.find(".item-photo").length&&!confirm("现在离开会丢失图片，确认吗"))return e._upcoming_act="pic",!1}}}(Do.ISay),function(e){e.actions.topic=function(){var t=e.node_textarea,i=t[0],n=i.value.length;i.focus();var a=i.value,o=t.get_selection(),r=o.text;if(start=o.start,end=o.end,"#"==a.charAt(start-1)&&"#"==a.charAt(end))return e.done();var s="#"+(r||"话题")+"#";i.value=a.substring(0,start)+s+a.substring(end,n),""===r&&t.set_selection(start+1,start+3),e.done()},e.initials.topic=function(){var t=e.node_textarea;t[0];document.selection&&t.bind("keyup mousedown mouseup focus",function(e){this._saved_range=document.selection.createRange()})},e.action_settings.topic={exclusive:!1}}(Do.ISay)},"add"in Do?Do("common",function(){Do._isay()}):Do._isay();