"use strict";function Status(t,e){return this.id=e,this.$node=t,this.ACTIVITY_API="https://m.douban.com/rexxar/api/v2/",this.aid=this.$node.attr("data-aid"),this.atype=this.$node.attr("data-atype"),this.$reshareNode=this.$node.hasClass("status-reshared-wrapper")&&!this.$node.hasClass("from-detail")&&this.$node,this.$others=$(this.$node.find(".others")[0]),this.$actions=$(this.$node.find(".actions")[0]),this.$text=$(this.$node.find(".comment-text")[0]),this.count_tmpl='<span class="count {cls}-count">&nbsp;({total})</span>',this.reshareNodeH=function(){return this.$reshareNode.height()},this.clearReshareNodeH=function(){this.$reshareNode&&(this.$reshareNode.get(0).style.height=null)},this.resetReshareNodeH=function(){if(this.$reshareNode){this.clearReshareNodeH();var t=this.$others[0].getBoundingClientRect().height;this.$reshareNode.height(this.reshareNodeH()+t)}},this}!function(t){function e(e,s){var i=s.maxLen,n=void 0===i?140:i,o=s.title,r=void 0===o?"转发":o,d=s.width,c=void 0===d?620:d,h=s.cls,l=void 0===h?"dialog-reshare":h,u=s.sid,p=s.aid,m=s.api,f=void 0===m?"/j/status/reshare":m,v=["group-pics-small"],g={loading:["loading","发布中..."],success:["success","已发布","发布成功"],error:["error","Oops...请重试"]},$=void 0,C=0,b=void 0,w=void 0,x=void 0,k=n-C,N=void 0,y="js-disabled",_=p?"data-aid="+p:"data-sid="+u,A=function(){var e=t(".status-reshared-wrapper[data-sid="+u+"]").length,a=t(e?".status-reshared-wrapper[data-sid="+u+"]":".status-item["+_+"]"),s=a.clone();s.find(".others").remove(),s.find(".actions").remove(),s.find(".quote-expand").remove(),s.find(".st-bottom-line").detach();for(var i="1018"===s.attr("data-object-kind")?"say":"",n=0,o=v.length;n<o;n++)s.find("."+v[n]).removeClass(v[n]);return s=e?s.html():'\n        <div class="status-real-wrapper '+i+'" '+_+">\n          "+s.html()+"\n        </div>\n        "},R=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:j();return C=t.replace(/((http|https):\/\/[\.\-_\/a-zA-Z0-9~\?%#=@:&;*+]+\b[\?#\/\*]*)/gi,function(t){return 0===t.indexOf("https://dou.bz")?"https://dou.bz/XXXXXX":"http://dou.bz/XXXXXX"}).length,k=n-C,T(),C<=n},T=function(){return k<10?(k>=0?(x.hasClass("negative")&&x.removeClass("negative"),N.hasClass(y)&&N.removeClass(y)):(x.addClass("negative"),N.addClass(y)),x.html(k)):(N.hasClass(y)&&N.removeClass(y),void x.html(""))},j=function(){return b=w.val()},D='\n      <div class="dialog-reshare-status-hd" '+_+'>\n        <p class="highlighter mention-highlighter"></p>\n        <p class="highlighter error-highlighter"></p>\n        <textarea class="reshare-text-input" rows="5" placeholder="说说看法..."></textarea>\n      </div>\n      <div class="dialog-reshare-status-bd status-item">\n        '+A()+'\n      <strong class="left-num"></strong>\n      </div>\n      ',H=function(){var t=$.node.find("p.mention-highlighter code");return t.each(function(t,e){var a=e.getAttribute("data-id"),s=e.innerHTML;j(),b.indexOf(s)!=-1&&(b=b.replace(s,"@"+a))}),b},E=[{text:"发布",method:function(){var e=void 0;R(b)&&!N.hasClass(y)&&t.ajax({url:f,type:"POST",dataType:"json",data:{ck:get_cookie("ck"),sid:u,text:H()},beforeSend:function(t){t.withCredentials=!0,e&&window.clearTimeout(e),N.addClass(y),N.addClass(g.loading[0]),N.val(g.loading[1])},success:function(s){return!s.r&&a?(x[0].className=g.success[0],x.html(g.success[2]).addClass("fadein"),N[0].className=g.success[0],N.val(g.success[1]),t(a.node).addClass("fadeout"),void(e=window.setTimeout(function(){a.close()},1200))):void(s.r&&window.alert(s.msg))},error:function(){x.addClass(g.error[0]).html(g.error[1])},complete:function(){N.removeClass(y)}})}}],S=function(){var e=t("."+l);e.hasClass("fadeout")&&e.removeClass("fadeout"),w=e.find("textarea"),x=e.find(".left-num"),N=e.find('.ft input[type="button"]');var a=e.find("p.mention-highlighter");return w._tagsug_api||Do("tagsug",function(){w.tagsug({max:5,highlight:!0,highlighter:a})}),$};if("undefined"!=typeof dui&&dui.Dialog)return $=a=dui.Dialog({title:r,width:c,cls:l,buttons:E,content:D}),$.init=S,$.node.bind("input keyup",function(){R()}),$.node.delegate("a","click",function(t){var e=t.currentTarget,a=e.getAttribute("href");a&&t.preventDefault()}),$}var a=void 0;t.fn.reshareDialog=function(s){return a&&a.close(),new e(t(this),s)}}(jQuery),Status.prototype={constructor:Status,init:function(){this.bindActionsEvents(),this.bindUploadEvents(),this.bindExpandEvents()},updateCount:function(t,e,a){var s,i=t.next(".count"),n=0|i.attr("data-count");(n||a)&&(s=n+a)?(i.remove(),t.after($(this.count_tmpl.replace(/{cls}/g,e).replace(/{total}/g,s))),i=t.next(".count"),i.attr("data-count",s)):i.remove()},bindUploadEvents:function(){this.$node.find(".group-pic:not(.is-widgets) .upload-pic").toggle(function(){var t=this.getAttribute("data-median-src"),e=this.getAttribute("data-raw-src"),a='<div class="attachment-ft"><a href="'+e+'" target="_blank">查看原图</a></div>',s=this;$(this).css("opacity","0.5").parent().addClass("upload-pic-preview");var i=new Image;i.src=t,i.onload=function(){s.src=this.src,$(s).removeClass("big").addClass("small").css("opacity","1").parent().after(a)}},function(){var t=$(this),e=$(window),a=t.height()>e.height();t.css({width:"auto",height:"auto"}).attr("src",this.getAttribute("data-small-src")||this.getAttribute("data-median-src").replace(/median/g,"small")).removeClass("small").addClass("big").parent().removeClass("upload-pic-preview").nextAll().remove(),a&&e.scrollTop(t.closest(".status-item").offset().top)})},bindExpandEvents:function(){function t(t){$.each(t.find("img"),function(){var t=this.getAttribute("data-small-src")||this.getAttribute("data-median-src");t&&(this.src=t)}),t.removeClass("group-pics-small"),a.resetReshareNodeH();var e=t.closest(".status-item").offset().top;$(window).scrollTop()>e&&$(window).scrollTop(e)}function e(t){t.addClass("group-pics-small"),a.$reshareNode.length&&a.updateReshareNode("auto"),$.each(t.find("img"),function(){var t=this,e=t.getAttribute("data-median-src");if($(t).data("isanimated")&&(e=$(t).next("a").attr("href")),e){var a=new Image;a.onload=function(){t.src=e,$(t).parents(".group-pic").removeClass("loading")},a.src=e,$(t).parents(".group-pic").addClass("loading")}})}this.$node.find(".group-pic").hover(function(){$(this).addClass("group-pic-over")},function(){$(this).removeClass("group-pic-over")});var a=this,s=a.$node.find(".group-pics"),i=a.$node.find("blockquote.quote-clamp"),n=$('<span data-expand="false" class="quote-expand">...(展开)</span>');if(s.click(function(a){if(a.preventDefault(),a.stopPropagation(),"A"===$(a.target)[0].tagName)return void window.open(a.target.href);var s=$(this);s.hasClass("group-pics-small")?t(s):e(s)}),i.length){var o=i.find("p"),r=o.innerHeight(),d=i.innerHeight();r>d&&(n.bind("click",function(t){t.stopPropagation(),n.data("expand")?(i.addClass("quote-clamp"),a.resetReshareNodeH(),n.text("...(展开)"),n.data("expand",!1)):(i.removeClass("quote-clamp"),a.resetReshareNodeH(),n.text("(收起)"),n.data("expand",!0))}),n.insertAfter(i))}},bindActionsEvents:function(){var t=this;this.$node.delegate("[data-action-type]","click",function(e){e.preventDefault();var a=$(this).attr("data-action-type");t[a]($(e.target))}).delegate(".add-more-comments","click",function(t){t.preventDefault(),$(this).parent().removeClass("comment-posted").find(".comment-text").focus()}).find("form").bind("submit",function(e){e.preventDefault(),$.trim($(this).find(".comment-text").val())&&t.addComment()})},getAllCommenters:function(){var t=[],e={};window.crt_uid&&(e[window.crt_uid]=1),$("a.commenter",this.$comments[0]).each(function(a,s){var i=s.href.split("/"),n=i[i.length-2];n in e||(t.push({uid:n,avatar:s.getAttribute("data-avatar"),username:s.innerHTML}),e[n]=1)}),this.commenters=t},filteredCommenters:function(t,e,a){for(var s=this.commenters||{},i=e||5,n=[],o=a||{},r=0,d=s.length;r<d&&n.length<i;r++){var c=s[r];c.uid in o||(t?c.username.indexOf(t)>-1?n.push(c):c.uid.indexOf(t)>-1&&n.push(c):n.push(c))}return{users:n}},bindCommentsEvents:function(){var t=this;t.getAllCommenters(),t.$others.delegate("p .btn-del","mouseenter",function(){$(this).parent().addClass("mover")}).delegate("p .btn-del","mouseleave",function(){$(this).parent().removeClass("mover")}),t.$text._tagsug_api||Do("tagsug",function(){t.$text.tagsug({max:5,customData:function(){return t.filteredCommenters.apply(t,arguments)}})})},react:function(t){var e=this;t.removeClass("btn");var a=t.text(),s={reaction_type:t.attr("data-activity-reaction"),ck:get_cookie("ck")};$.ajax({type:"post",traditional:!0,url:e.ACTIVITY_API+e.atype+"/"+e.aid+"/react",data:s,beforeSend:function(t){t.withCredentials=!0},success:function(s){if(1===s.reaction_type){var i="已"+a;t.text(i).attr({class:"btn btn-unlike","data-activity-reaction":0}),e.updateCount(t,"like",1)}else{var i=a.slice(1);t.text(i).attr({class:"btn btn-like","data-activity-reaction":1}),e.updateCount(t,"like",-1)}}})},like:function(t){var e=this;t.removeClass("btn"),$.post_withck("/j/status/like",{sid:this.id},function(a){a=$.parseJSON(a),a.r||(t.text("已赞").attr({"data-action-type":"unlike",class:"btn btn-unlike"}),e.updateCount(t,"like",1))})},unlike:function(t){var e=this;$.post_withck("/j/status/unlike",{sid:this.id},function(a){a=$.parseJSON(a),a.r||(t.text("赞").attr({"data-action-type":"like",class:"btn btn-like"}),e.updateCount(t,"like",-1))})},showLikes:function(t){var e=$('<div class="likers"><em></em> <span>赞</span></div>');""!==t&&(e.find("em").html(t),this.$others.find(".likers").remove().end().prepend(e))},showComments:function(t){var e=this;e.$comments=e.$others.find(".comments"),t.text("加载中").attr("data-action-type","hideComments");var a=e.$comments.find(".comments-items");$.getJSON("/j/status/comments",{sid:e.id},function(s){t.text("隐藏回应");var i=s.comments;e.showLikes(s.likers),a.html(i),t.data("count",s.count),e.$others.show(),e.$reshareNode.length&&e.showReshareComments(),e.bindCommentsEvents()})},hideComments:function(t){var e=t.data("count");t.text((e||"")+"回应").attr("data-action-type","showComments"),this.$others.hide(),this.$reshareNode.length&&this.hideReshareComments()},showReshareComments:function(t){var e=this,a=e.$reshareNode.find(".group-pics-small");if(a.length){a.removeClass("group-pics-small");var s=e.$reshareNode.offset().top;$(window).scrollTop()>s&&$(window).scrollTop(s)}e.updateReshareNode()},updateReshareNode:function(t){var e=this;if(e.$reshareNode.length){var a=e.$others[0].getBoundingClientRect().height;if("auto"===t){var s=e.$reshareNode.find(".actions"),i=e.$reshareNode.find(".actions .btn-action-reply"),n=e.$reshareNode.find(".others");s.length&&s.css("bottom","0"),n.length&&n.hide();var o=i.data("count");i.text((o||"")+"回应").attr("data-action-type","showComments"),e.$reshareNode.css("height","auto")}else e.resetReshareNodeH(),e.$actions.css("bottom",+a+"px"),e.$others.css("bottom","15px")}},hideReshareComments:function(){this.$actions.css("bottom","0"),this.clearReshareNodeH()},addComment:function(){var t=this,e=t.$node.find(".comment-text"),a=e.val();e.val(a=t.$text._tagsug_api[0].cleanVal(a)),$.post_withck("/j/status/comments",{sid:t.id,text:a},function(e){e=$.parseJSON(e),t.$comments.find(".comments-items").append(e.comment),t.$actions.find(".btn-action-reply").data().count+=1,t.updateReshareNode()}),e.val("").parent().addClass("comment-posted")},deleteComment:function(t){var e=this,a=t.attr("data-cid"),s=t.attr("data-sid"),i=confirm("确定要删除此回应吗？"),n=this.$node.find('input[name="ck"]').val();i&&$.ajax({type:"DELETE",url:"/j/status/comments",data:{ck:n,cid:a,sid:s},success:function(){t.parents("p").remove(),e.$actions.find(".btn-action-reply").data().count-=1,e.updateReshareNode()}})},reshare:function(t){var e=this,a=$(this),s="/j/status/reshare";return e.aid&&(s=e.ACTIVITY_API+e.atype+"/"+e.aid+"/reshare"),$.fn.reshareDialog&&t.hasClass("new-reshare")?void("undefined"==typeof dui?Do("dialog",function(){a.reshareDialog({maxLen:140,sid:e.id,aid:e.aid,api:s}).init().open()}):a.reshareDialog({maxLen:140,sid:e.id,aid:e.aid,api:s}).init().open()):(t.removeClass("btn"),void $.post_withck(s,{sid:this.id},function(e){e=$.parseJSON(e),e&&t.text("已转发").attr({"data-action-type":"unreshare","data-reshare-id":e.reshare_id,class:"btn btn-unreshare"}).addClass("btn")}))},unreshare:function(t){var e=t.attr("data-reshare-id");$.post_withck("/j/status/unreshare",{sid:e},function(e){e.r||t.text("转发").attr({"data-action-type":"reshare",class:"btn btn-reshare"}).removeAttr("data-reshare-id")})},deleteStatus:function(t){var e=this,a=t.attr("data-widget-id"),s=t.attr("data-unreshare");return s?void $.post_withck("/j/status/delete",{sid:s,wid:a},function(t){t.r?alert("取消转发失败，请刷新页面再试"):e.$node.slideUp("normal",function(){$('.status-wrapper[data-sid="'+s+'"]').remove()})}):void(confirm("确定要删除此条广播？")&&$.post_withck("/j/status/delete",{sid:this.id,wid:a},function(t){t.r?alert("删除失败，请刷新页面再试"):e.$node.slideUp("normal",function(){$(this).remove()})}))}};